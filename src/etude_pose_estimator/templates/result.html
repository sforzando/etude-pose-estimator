<!-- Comparison Result Display -->
<div class="space-y-6 animate-fade-in">
  <!-- Image Comparison -->
  {% if reference_name or uploaded_image_url %}
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="card-title text-primary text-lg font-bold">
        <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
        </svg>
        ç”»åƒæ¯”è¼ƒ
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <!-- Reference Pose Skeleton -->
        {% if reference_name %}
        <div>
          <p class="font-semibold text-center mb-2">åŸºæº–ãƒãƒ¼ã‚ºéª¨æ ¼</p>
          <div class="card bg-base-200">
            <figure class="px-6 pt-6">
              <img src="/api/references/{{ reference_name }}/skeleton" alt="{{ reference_name }}"
                class="rounded-xl max-h-96 w-full object-contain"
                onerror="this.parentElement.innerHTML='<div class=\'text-center p-8 text-base-content/50\'>éª¨æ ¼å›³ãªã—</div>'" />
            </figure>
            <div class="card-body items-center text-center">
              <p class="text-sm font-medium">{{ reference_name }}</p>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Uploaded Image Skeleton -->
        {% if uploaded_skeleton_url %}
        <div>
          <p class="font-semibold text-center mb-2">è§£æç”»åƒéª¨æ ¼</p>
          <div class="card bg-base-200">
            <figure class="px-6 pt-6">
              <img src="{{ uploaded_skeleton_url }}" alt="è§£æç”»åƒéª¨æ ¼" class="rounded-xl max-h-96 w-full object-contain" />
            </figure>
            <div class="card-body items-center text-center">
              <p class="text-sm text-base-content/70">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ</p>
            </div>
          </div>
        </div>
        {% elif uploaded_image_url %}
        <!-- Fallback to original image if skeleton not available -->
        <div>
          <p class="font-semibold text-center mb-2">è§£æç”»åƒ</p>
          <div class="card bg-base-200">
            <figure class="px-6 pt-6">
              <img src="{{ uploaded_image_url }}" alt="è§£æç”»åƒ" class="rounded-xl max-h-96 w-full object-contain" />
            </figure>
            <div class="card-body items-center text-center">
              <p class="text-sm text-base-content/70">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒï¼ˆéª¨æ ¼å›³ç”Ÿæˆå¤±æ•—ï¼‰</p>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- 3D Pose Comparison -->
  {% if uploaded_pose_3d and reference_pose_3d %}
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="card-title text-primary text-lg font-bold">
        <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" />
        </svg>
        3Då§¿å‹¢æ¯”è¼ƒ
      </div>
      <p class="text-sm text-base-content/70 mb-4">
        ã‚«ãƒ¡ãƒ©è§’åº¦ã®é•ã„ã‚’å¸åã—ãŸ3Då§¿å‹¢ã®æ¯”è¼ƒã€‚ãƒã‚¦ã‚¹ã§å›è»¢ãƒ»ã‚ºãƒ¼ãƒ ã§ãã¾ã™ã€‚
      </p>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <!-- Reference Pose 3D -->
        <div class="w-full">
          <p class="font-semibold text-center mb-2">åŸºæº–ãƒãƒ¼ã‚ºï¼ˆ3Dï¼‰</p>
          <div id="reference-3d-plot" class="bg-base-200 rounded-xl w-full overflow-hidden" style="height: 450px;"></div>
        </div>

        <!-- Uploaded Pose 3D -->
        <div class="w-full">
          <p class="font-semibold text-center mb-2">è§£æãƒãƒ¼ã‚ºï¼ˆ3Dï¼‰</p>
          <div id="uploaded-3d-plot" class="bg-base-200 rounded-xl w-full overflow-hidden" style="height: 450px;"></div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Similarity Score Card -->
  <div class="stats shadow w-full">
    <div class="stat">
      <div class="stat-figure text-primary">
        <svg fill="none" viewBox="0 0 24 24" class="inline-block w-8 h-8 stroke-current">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <div class="stat-title">é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢</div>
      <div class="stat-value
                {% if similarity_score >= 0.85 %}text-success
                {% elif similarity_score >= 0.60 %}text-warning
                {% else %}text-error{% endif %}">
        {{ "%.1f"|format(similarity_score * 100) }}%
      </div>
      <div class="stat-desc">
        {% if similarity_score >= 0.85 %}
        ç´ æ™´ã‚‰ã—ã„ï¼ã»ã¼å®Œç’§ã§ã™ ğŸ‰
        {% elif similarity_score >= 0.60 %}
        è‰¯å¥½ã§ã™ã€‚ã‚‚ã†å°‘ã—æ”¹å–„ã§ãã¾ã™ ğŸ’ª
        {% else %}
        æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ ğŸ“
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Angle Differences Table -->
  {% if angle_differences %}
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="card-title text-primary text-lg font-bold">
        <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" />
        </svg>
        é–¢ç¯€è§’åº¦ã®å·®åˆ†
      </div>

      <div class="overflow-x-auto">
        <table class="table table-zebra" aria-label="é–¢ç¯€è§’åº¦ã®å·®åˆ†ä¸€è¦§">
          <caption class="sr-only">é–¢ç¯€è§’åº¦ã®å·®åˆ†ä¸€è¦§è¡¨</caption>
          <thead>
            <tr>
              <th>é–¢ç¯€å</th>
              <th class="text-right">è§’åº¦å·®ï¼ˆåº¦ï¼‰</th>
              <th class="text-center">è©•ä¾¡</th>
            </tr>
          </thead>
          <tbody>
            {% for joint_name, diff in angle_differences.items() %}
            <tr>
              <td class="font-medium">{{ joint_name }}</td>
              <td class="text-right font-mono">{{ "%.1fÂ°"|format(diff) }}</td>
              <td class="text-center">
                {% if diff < 5 %} <span class="badge badge-success">å„ªç§€</span>
                  {% elif diff < 15 %} <span class="badge badge-warning">è¦æ”¹å–„</span>
                    {% else %}
                    <span class="badge badge-error">è¦æ³¨æ„</span>
                    {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Detailed Metrics (Expanded by default) -->
  {% if comparison_metrics %}
  <div class="collapse collapse-arrow bg-base-100 shadow-xl" role="region" aria-labelledby="detailed-metrics-title">
    <input type="checkbox" checked aria-label="è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é–‹é–‰" />
    <div class="collapse-title text-xl font-medium" id="detailed-metrics-title">
      è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰
    </div>
    <div class="collapse-content">
      <div class="stats stats-vertical lg:stats-horizontal shadow w-full mt-4">
        <div class="stat">
          <div class="stat-title">å¹³å‡è·é›¢</div>
          <div class="stat-value text-sm">{{ "%.4f"|format(comparison_metrics.mean_distance) }}</div>
          <div class="stat-desc">3Dç©ºé–“ã§ã®å¹³å‡ãšã‚Œ</div>
        </div>

        <div class="stat">
          <div class="stat-title">æœ€å¤§è·é›¢</div>
          <div class="stat-value text-sm">{{ "%.4f"|format(comparison_metrics.max_distance) }}</div>
          <div class="stat-desc">æœ€ã‚‚ãšã‚Œã¦ã„ã‚‹é–¢ç¯€</div>
        </div>

        <div class="stat">
          <div class="stat-title">æœ€å¤§ãšã‚Œé–¢ç¯€</div>
          <div class="stat-value text-sm">{{ comparison_metrics.max_distance_joint }}</div>
          <div class="stat-desc">æœ€ã‚‚æ”¹å–„ãŒå¿…è¦ãªéƒ¨ä½</div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Japanese Advice (Primary) -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="card-title text-primary text-lg font-bold">
        <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
        </svg>
        æ”¹å–„ã‚¢ãƒ‰ãƒã‚¤ã‚¹
      </div>

      <!-- Overall Assessment -->
      <div class="prose max-w-none">
        <p class="text-lg font-semibold mb-2">ç·åˆè©•ä¾¡</p>
        <p class="text-base-content/80">{{ advice.ja.overall }}</p>
      </div>

      <!-- Improvements -->
      {% if advice.ja.improvements %}
      <div class="prose max-w-none mt-4">
        <p class="text-lg font-semibold mb-2">æ”¹å–„ãƒã‚¤ãƒ³ãƒˆï¼ˆå„ªå…ˆé †ï¼‰</p>
        <ol class="list-decimal list-inside space-y-2">
          {% for improvement in advice.ja.improvements %}
          <li class="text-base-content/80">{{ improvement }}</li>
          {% endfor %}
        </ol>
      </div>
      {% endif %}

      <!-- Priority Joints -->
      {% if advice.ja.priority_joints %}
      <div class="alert alert-info mt-4">
        <svg fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span><strong>é‡ç‚¹éƒ¨ä½:</strong> {{ advice.ja.priority_joints }}</span>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Render 3D comparison plots
  {% if uploaded_pose_3d and reference_pose_3d %}
  (function() {
    // H36M skeleton connections
    const skeleton_connections = [
      // Right leg (blue)
      [[0, 1], 'R'], [[1, 2], 'R'], [[2, 3], 'R'],
      // Left leg (red)
      [[0, 4], 'L'], [[4, 5], 'L'], [[5, 6], 'L'],
      // Spine and head (middle - gray)
      [[0, 7], 'M'], [[7, 8], 'M'], [[8, 9], 'M'], [[9, 10], 'M'],
      // Arms
      [[8, 11], 'M'], [[8, 14], 'M'],
      [[11, 12], 'L'], [[12, 13], 'L'],
      [[14, 15], 'R'], [[15, 16], 'R'],
    ];

    const colors = { 'L': 'rgb(239, 68, 68)', 'R': 'rgb(59, 130, 246)', 'M': 'rgb(156, 163, 175)' };

    function createPlot(elementId, pose3d_raw, title) {
      // Convert coordinates for proper 3D visualization
      const pose3d = pose3d_raw.map(p => [-p[0], -p[2], -p[1]]);

      // Calculate dynamic range for proper centering
      const all_coords = pose3d.flat();
      const max_coord = Math.max(...all_coords.map(Math.abs));
      const plot_range = Math.max(max_coord * 1.2, 1.5);  // At least 1.5, but expand if needed

      // Create skeleton lines
      const traces = skeleton_connections.map(([[i, j], side]) => {
        return {
          x: [pose3d[i][0], pose3d[j][0]],
          y: [pose3d[i][1], pose3d[j][1]],
          z: [pose3d[i][2], pose3d[j][2]],
          mode: 'lines',
          type: 'scatter3d',
          line: { color: colors[side], width: 8 },
          hoverinfo: 'skip',
          showlegend: false,
        };
      });

      // Add joints
      traces.push({
        x: pose3d.map(p => p[0]),
        y: pose3d.map(p => p[1]),
        z: pose3d.map(p => p[2]),
        mode: 'markers',
        type: 'scatter3d',
        marker: { size: 6, color: 'rgb(255, 255, 255)', line: { color: 'rgb(0, 0, 0)', width: 2 } },
        hoverinfo: 'text',
        text: pose3d.map((_, idx) => `é–¢ç¯€ ${idx}`),
        showlegend: false,
      });

      const layout = {
        autosize: true,
        scene: {
          aspectmode: 'cube',
          camera: {
            eye: { x: 1.5, y: 1.5, z: 1.5 },
            center: { x: 0, y: 0, z: 0 }
          },
          xaxis: {
            title: { text: 'X', font: { color: 'white', size: 12 } },
            tickfont: { color: 'white', size: 10 },
            backgroundcolor: 'rgb(30, 30, 50)',
            gridcolor: 'rgb(80, 80, 100)',
            range: [-plot_range, plot_range],
          },
          yaxis: {
            title: { text: 'Y', font: { color: 'white', size: 12 } },
            tickfont: { color: 'white', size: 10 },
            backgroundcolor: 'rgb(30, 30, 50)',
            gridcolor: 'rgb(80, 80, 100)',
            range: [-plot_range, plot_range],
          },
          zaxis: {
            title: { text: 'Z', font: { color: 'white', size: 12 } },
            tickfont: { color: 'white', size: 10 },
            backgroundcolor: 'rgb(30, 30, 50)',
            gridcolor: 'rgb(80, 80, 100)',
            range: [-plot_range, plot_range],
          },
          bgcolor: 'rgb(20, 20, 30)',
        },
        paper_bgcolor: 'rgb(20, 20, 30)',
        margin: { l: 0, r: 0, t: 10, b: 0 },
        hovermode: 'closest',
      };

      const config = { responsive: true, displayModeBar: true, displaylogo: false };

      Plotly.newPlot(elementId, traces, layout, config);
    }

    // Wait for Plotly to be loaded, then render both plots
    function renderPlots() {
      if (typeof Plotly === 'undefined') {
        // Plotly not loaded yet, wait a bit
        setTimeout(renderPlots, 100);
        return;
      }

      const referencePose3d = {{ reference_pose_3d | tojson }};
      const uploadedPose3d = {{ uploaded_pose_3d | tojson }};

      createPlot('reference-3d-plot', referencePose3d, 'åŸºæº–ãƒãƒ¼ã‚º');
      createPlot('uploaded-3d-plot', uploadedPose3d, 'è§£æãƒãƒ¼ã‚º');
    }

    // Start rendering
    renderPlots();
  })();
  {% endif %}
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }
</style>
